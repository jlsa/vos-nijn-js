<html>

<head>
  <title>Foxes and Rabbits JS</title>
  <style type="text/css">
    body {
      background: #1A1A1A;
    }

    #layers {
      width: 500px;
      height: 500px;
      position: relative;
      margin: 0 auto;
    }

    .layer {
      position: absolute;
      left: 0px;
      top: 0px;
    }

    #gb-layer {
      z-index: 1;
    }

    #game-layer {
      z-index: 2;
    }

    #ui-layer {
      z-index: 3;
    }
  </style>
</head>

<body>

  <div id="layers"></div>
  <script src="component.js" type="text/javascript"></script>
  <script src="ui-elements/text-element.js"></script>
  <script src="simulator.js" type="text/javascript"></script>
  <script src="actor.js" type="text/javascript"></script>
  <script src="actors/grass-actor.js" type="text/javascript"></script>
  <script src="board.js" type="text/javascript"></script>
  <script src="gui.js" type="text/javascript"></script>


  <script type="text/javascript">
    const layerNames = ['bg-layer', 'game-layer', 'ui-layer'];
    const layers = [];
    let textElement;

    var game = {
      board: undefined
    };

    let simulator;
    let gui;

    var settings = {
      width: 50 * 10,
      height: 50 * 10,
      tileSize: { w: 10, h: 10 },
      rows: 50,
      cols: 50
    };

    let oldTimeStamp;
    let fps;
    let showFps = false;

    const init = () => {
      layerNames.forEach(layerName => {
        let parentNode = document.getElementById('layers');
        let canvas = document.createElement('canvas');
        canvas.setAttribute('width', settings.width);
        canvas.setAttribute('height', settings.height);
        canvas.classList.add('layer');
        parentNode.appendChild(canvas);
        canvas.offscreenCanvas = document.createElement('canvas');
        canvas.offscreenCanvas.width = canvas.getAttribute('width');
        canvas.offscreenCanvas.height = canvas.getAttribute('height');
        let context = canvas.getContext('2d');

        layer = {
          children: [],
          addChild: child => {
            layer.children[layer.children.length] = child;
          },
          canvas: canvas,
          context: context,
          render: (deltaTime) => {
            layer.children.forEach(child => {
              child.render(context, deltaTime);
            });
          },
          update: (deltaTime) => {
            layer.children.forEach(child => {
              child.update(deltaTime);
            });
          }
        };
        layers[layers.length] = layer;
      });

      simulator = new Simulator();
      layers[1].addChild(simulator);
      simulator.addBoard(new Board(settings.rows, settings.cols, settings.tileSize));

      gui = new Gui();
      layers[2].addChild(gui);

      entities.forEach((entity, index) => {
        const newElement = new TextElement(
          this.layer.context,
          `${entity.name}: #`,
          0,
          index * 20
        );
        gui.add(newElement);
      });

      window.requestAnimationFrame(gameloop);
    };

    const gameloop = (timeStamp) => {
        deltaTime = (timeStamp - oldTimeStamp) / 1000;
        oldTimeStamp = timeStamp;
        if (isNaN(deltaTime)) {
          deltaTime = 0;
        }
        update(deltaTime);
        render(deltaTime);
        window.requestAnimationFrame(gameloop);
      }

    function render(deltaTime) {
      layers.forEach(layer => {
        layer.context.clearRect(0, 0, settings.width, settings.height);
        layer.render(deltaTime);
      });
    };

    function update(deltaTime) {
      layers.forEach(layer => {
        layer.update(deltaTime);
      });
    }

    init();
  </script>
</body>

</html>